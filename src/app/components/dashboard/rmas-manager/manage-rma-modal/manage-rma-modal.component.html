<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 lg:pl-52">
  <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 flex justify-between items-center sticky top-0 z-10">
      <div>
        <h2 class="text-2xl font-bold">Gestionar RMA: {{ rma.rma_number }}</h2>
        <p class="text-sm text-purple-100 mt-1">
          Pedido: {{ rma.order_id }} | Estado: 
          <span class="font-semibold px-2 py-0.5 rounded-full" [ngClass]="getStateColor(rma.estado)">
            {{ getStateLabel(rma.estado) }}
          </span>
        </p>
      </div>
      <button (click)="closeModal()" class="text-white hover:text-gray-200 transition-colors">
        <fa-icon [icon]="faTimes" class="text-2xl"></fa-icon>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <!-- Alerts -->
      @if (error(); as errorMsg) {
        <div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-4 flex items-start" role="alert">
          <fa-icon [icon]="faExclamationTriangle" class="mr-2 mt-0.5"></fa-icon>
          <div>
            <span class="font-medium">Error:</span> {{ errorMsg }}
          </div>
        </div>
      }

      @if (success(); as successMsg) {
        <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mb-4" role="alert">
          <span class="font-medium">Éxito:</span> {{ successMsg }}
        </div>
      }

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Información General -->
        <div class="lg:col-span-2">
          <form [formGroup]="updateDataForm" (ngSubmit)="handleUpdateData()" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="p-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Información General</h3>
              <div class="space-y-4">
                <div>
                  <label for="motivo" class="block text-sm font-medium text-gray-700 mb-1">
                    Motivo de la Devolución
                  </label>
                  <textarea 
                    id="motivo" 
                    formControlName="motivo" 
                    rows="4" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" 
                    placeholder="Describe el motivo...">
                  </textarea>
                </div>

                <div>
                  <label for="notas" class="block text-sm font-medium text-gray-700 mb-1">
                    Notas Internas
                  </label>
                  <textarea 
                    id="notas" 
                    formControlName="notas" 
                    rows="3" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" 
                    placeholder="Notas visibles solo para el equipo...">
                  </textarea>
                </div>

                <div>
                  <label for="evidencias" class="block text-sm font-medium text-gray-700 mb-1">
                    Evidencias (JSON)
                  </label>
                  <textarea 
                    id="evidencias" 
                    formControlName="evidencias" 
                    rows="5" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm font-mono" 
                    placeholder='Ej: [{"url": "..."}]'>
                  </textarea>
                  @if (updateDataForm.get('evidencias')?.hasError('invalidJson')) {
                    <p class="mt-1 text-xs text-red-600">El formato de las evidencias no es un JSON válido.</p>
                  }
                </div>
              </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
              <button 
                type="submit" 
                [disabled]="updateDataForm.invalid || isLoading()" 
                class="inline-flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                @if (isLoading()) {
                  <fa-icon [icon]="faSpinner" class="animate-spin"></fa-icon>
                } @else {
                  <fa-icon [icon]="faSave"></fa-icon>
                }
                <span>Guardar Cambios</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Gestionar Flujo -->
        <div class="lg:col-span-1">
          <form [formGroup]="updateStateForm" (ngSubmit)="handleUpdateState()" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="p-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Gestionar Flujo</h3>
              <div class="space-y-4">
                <div>
                  <label for="nextState" class="block text-sm font-medium text-gray-700 mb-1">
                    Cambiar Estado a:
                  </label>
                  <select 
                    id="nextState" 
                    formControlName="nextState" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                    <option value="" disabled>Selecciona un estado...</option>
                    @for (opt of stateOptions; track opt[1]) {
                      <option [value]="opt[1]">{{ opt[0] }}</option>
                    }
                  </select>
                </div>

                <div>
                  <label for="stateNotas" class="block text-sm font-medium text-gray-700 mb-1">
                    Notas del Cambio de Estado
                  </label>
                  <textarea 
                    id="stateNotas" 
                    formControlName="notas" 
                    rows="3" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" 
                    placeholder="Opcional: agrega una nota...">
                  </textarea>
                </div>
              </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
              <button 
                type="submit" 
                [disabled]="updateStateForm.invalid || isLoading()" 
                class="inline-flex items-center space-x-2 w-full justify-center bg-gray-700 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                @if (isLoading()) {
                  <fa-icon [icon]="faSpinner" class="animate-spin"></fa-icon>
                } @else {
                  <fa-icon [icon]="faPaperPlane"></fa-icon>
                }
                <span>Actualizar Estado</span>
              </button>
            </div>
          </form>

          <!-- Delete Button -->
          <div class="mt-4">
            <button 
              (click)="handleDelete()" 
              [disabled]="isLoading()" 
              class="w-full inline-flex items-center justify-center space-x-2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-150 disabled:opacity-50">
              <fa-icon [icon]="faTrash"></fa-icon>
              <span>Eliminar RMA</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
