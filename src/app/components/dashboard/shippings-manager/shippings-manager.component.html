<div class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4 sm:p- lg:p-8">

  <app-header-crud titulo="Envíos" descripcion="Gestiona y actualiza los envíos." textoBotonActualizar="Refrescar"
    placeholderInput="Buscar por Orden, Guía o Transportadora..." [filterByStatus]="true"
    [filterStatusValues]="['preparando', 'en_transito', 'entregado', 'fallido']" (actualizar)="loadShippings()"
    (clearFilters)="handleClearFilters()" (filterChange)="handleFilterChange($event)">
  </app-header-crud>

  <main class="flex p-2 flex-col lg:flex-row h-[calc(100vh-140px)] overflow-hidden mt-6">
    <div class="w-full lg:w-1/3 xl:w-1/2 overflow-y-auto pr-3 lg:border-r lg:border-gray-200">
      @if (isLoading) {
      <div class="flex items-center justify-center h-64">
        <fa-icon [icon]="faCircleNotch" size="3x" class="text-violet-500 animate-spin"></fa-icon>
      </div>
      } @else if (error) {
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
        <div class="flex items-center gap-3">
          <fa-icon [icon]="faExclamationTriangle"></fa-icon>
          <p class="font-bold">{{ error }}</p>
        </div>
      </div>
      } @else if (!shippings.length) {
      <div class="text-center text-gray-400 p-8">
        <fa-icon [icon]="faEye" size="3x" class="mb-3"></fa-icon>
        <p class="font-semibold">No se encontraron envíos</p>
        <p class="text-sm">Intenta con otros filtros o recarga la lista.</p>
      </div>
      } @else {
      <div class="space-y-3">
        @for (shipping of shippings; track shipping.id) {
        <div (click)="selectShipping(shipping)" [ngClass]="{
            'bg-violet-50 border-violet-500 shadow-md scale-[1.02]':
              selectedShipping?.id === shipping.id,
            'bg-white border-gray-200 hover:border-violet-400 hover:shadow-sm':
              selectedShipping?.id !== shipping.id
          }" class="p-4 border rounded-lg cursor-pointer transition-all duration-300">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500">Orden: {{ shipping.order_id }}</p>
              <p class="font-bold text-gray-800">
                {{ shipping.transportadora }}
              </p>
            </div>
            <span [ngClass]="getStatusInfo(shipping.estado).color"
              class="flex items-center gap-2 text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap">
              <fa-icon [icon]="getStatusInfo(shipping.estado).icon"></fa-icon>
              {{ getStatusInfo(shipping.estado).label }}
            </span>
          </div>
          <p class="text-xs text-gray-400 mt-2">Guía: {{ shipping.guia }}</p>
        </div>
        }
      </div>
      }
    </div>

    <div class="w-full lg:w-2/3 xl:w-3/4 overflow-y-auto pl-3 hidden lg:block">
      @if (selectedShipping && !isMobile) {
      <ng-container *ngTemplateOutlet="shippingDetails; context: { shipping: selectedShipping }"></ng-container>
      } @else {
      <div
        class="flex items-center justify-center h-full bg-white/60 border-2 border-dashed border-gray-300 rounded-lg">
        <div class="text-center text-gray-500">
          <fa-icon [icon]="faEye" size="4x" class="mb-4"></fa-icon>
          <p class="text-xl font-semibold">Selecciona un envío</p>
          <p>Elige un envío de la lista para ver sus detalles aquí.</p>
        </div>
      </div>
      }
    </div>
  </main>
</div>

<!-- Modal móvil desde abajo -->
@if (isDetailsModalOpen && isMobile) {
<div class="lg:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end" (click)="closeDetailsModal()">
  <div
    class="bg-white rounded-t-3xl w-full max-h-[85vh] overflow-y-auto animate__animated animate__slideInUp animate__faster"
    (click)="$event.stopPropagation()">
    <!-- Header del Modal -->
    <div
      class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center rounded-t-3xl z-50">
      <h2 class="text-xl font-bold text-violet-700">Detalles del Envío</h2>
      <button (click)="closeDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
    </div>

    <!-- Contenido del Modal (sin el header duplicado) -->
    <div class="p-4">
      @if (selectedShipping) {
      <!-- Info resumida para móvil -->
      <div class="mb-4">
        <p class="text-sm text-gray-500">Guía: {{ selectedShipping.guia }}</p>
        <div class="flex justify-between items-center mt-2">
          <p class="text-xs text-gray-600">Fecha estimada: <span class="font-semibold">{{ selectedShipping.fechaEstimada
              | date: 'mediumDate' }}</span></p>
        </div>
      </div>

      <!-- Información clave -->
      <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="text-sm">
          <span class="font-semibold text-gray-700">ID Orden:</span>
          <span class="ml-1 text-gray-900">{{ selectedShipping.order_id }}</span>
        </div>
        <div class="text-sm">
          <span class="font-semibold text-gray-700">Transportadora:</span>
          <span class="ml-1 text-gray-900">{{ selectedShipping.transportadora }}</span>
        </div>
        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
          <fa-icon [icon]="getStatusInfo(selectedShipping.estado).icon" size="lg"
            [ngClass]="getStatusInfo(selectedShipping.estado).color"></fa-icon>
          <span class="font-semibold text-lg text-gray-800">{{ getStatusInfo(selectedShipping.estado).label }}</span>
        </div>
        @if (selectedShipping.fechaEntregaReal) {
        <div class="text-sm">
          <span class="font-semibold text-gray-700">Entregado el:</span>
          <span class="ml-1 text-gray-900">{{ selectedShipping.fechaEntregaReal | date: 'longDate' }}</span>
        </div>
        }
      </div>

      <!-- Historial -->
      <h3 class="text-lg font-bold text-gray-800 mb-4">Historial</h3>
      <div class="relative pl-6 border-l-2 border-violet-100 space-y-5">
        @for (event of selectedShipping.historial; track event.timestamp) {
        <div class="relative">
          <div class="absolute -left-[30px] top-1 h-3 w-3 rounded-full"
            [ngClass]="getStatusInfo(event.status).color.replace('text-', 'bg-')"></div>
          <p class="text-xs text-gray-500">{{ event.timestamp | date: 'medium' }}</p>
          <p class="font-medium text-gray-800 mt-0.5" [ngClass]="getStatusInfo(event.status).color">
            {{ getStatusInfo(event.status).label }}
          </p>
          <p class="text-gray-700 text-sm mt-1">{{ event.description }}</p>
        </div>
        }
      </div>

      <!-- Botones de acción -->
      <div class="mt-8 pt-6 border-t border-gray-100 space-y-3">
        <button (click)="setShippingToView(selectedShipping.id)"
          *ngIf="selectedShipping.guia && selectedShipping.estado === 'en_transito'"
          class="w-full font-bold text-sm text-purple-600 py-2">
          <fa-icon [icon]="faTruck" class="text-purple-500 mr-1"></fa-icon>
          Ver Guia
        </button>
        <button (click)="openUpdateStatusModal()"
          class="w-full flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-5 rounded-lg shadow hover:bg-violet-700 justify-center">
          <fa-icon [icon]="faEdit"></fa-icon>
          <span>Actualizar Estado</span>
        </button>
      </div>
      }
    </div>
  </div>
</div>
}


<ng-template #shippingDetails let-shipping="shipping">
  @if (shipping) {
  <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 transition-all duration-300">

    <!-- Encabezado sticky - Solo visible en desktop -->
    <div class="sticky top-0 z-40 bg-white py-3 pb-4 mb-6 border-b border-gray-100">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h2 class="text-xl sm:text-2xl font-bold text-violet-700">Detalles del Envío</h2>
          <p class="text-sm text-gray-500 mt-1">Guía: {{ shipping.guia }}</p>
        </div>
        <div class="text-left sm:text-right w-full sm:w-auto">
          <p class="text-xs text-gray-600">Fecha entrega estimada</p>
          <p class="font-semibold text-lg text-gray-800">
            {{ shipping.fechaEstimada | date: 'longDate' }}
          </p>
          @if (shipping?.estado === 'entregado') {
          <p class="text-xs text-gray-600 mt-1">Fecha entrega real</p>
          <p class="font-semibold text-lg text-gray-800">
            {{ shipping.fechaEntregaReal | date: 'longDate' }}
          </p>
          }
        </div>
      </div>
    </div>

    <!-- Información clave en grid mejorado -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
      <div class="text-sm">
        <span class="font-semibold text-gray-700">ID Orden:</span>
        <span class="ml-1 text-gray-900">{{ shipping.order_id }}</span>
      </div>
      <div class="text-sm">
        <span class="font-semibold text-gray-700">Transportadora:</span>
        <span class="ml-1 text-gray-900">{{ shipping.transportadora }}</span>
      </div>
      <div class="col-span-1 sm:col-span-2 flex items-center gap-3 p-3 rounded-lg bg-gray-50">
        <fa-icon [icon]="getStatusInfo(shipping.estado).icon" size="lg"
          [ngClass]="getStatusInfo(shipping.estado).color"></fa-icon>
        <span class="font-semibold text-lg text-gray-800">{{ getStatusInfo(shipping.estado).label }}</span>
      </div>
      @if (shipping.fechaEntregaReal) {
      <div class="col-span-1 sm:col-span-2 text-sm">
        <span class="font-semibold text-gray-700">Entregado el:</span>
        <span class="ml-1 text-gray-900">{{ shipping.fechaEntregaReal | date: 'longDate' }}</span>
      </div>
      }
    </div>

    <!-- Historial con mejor espaciado -->
    <h3 class="text-lg font-bold text-gray-800 mb-4">Historial</h3>
    <div class="relative pl-6 border-l-2 border-violet-100 space-y-5">
      @for (event of shipping.historial; track event.timestamp) {
      <div class="relative">
        <div class="absolute -left-[30px] top-1 h-3 w-3 rounded-full"
          [ngClass]="getStatusInfo(event.status).color.replace('text-', 'bg-')"></div>
        <p class="text-xs text-gray-500">{{ event.timestamp | date: 'medium' }}</p>
        <p class="font-medium text-gray-800 mt-0.5" [ngClass]="getStatusInfo(event.status).color">
          {{ getStatusInfo(event.status).label }}
        </p>
        <p class="text-gray-700 text-sm mt-1">{{ event.description }}</p>
      </div>
      }
    </div>

    <!-- Botón mejorado -->
    <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
      <button (click)="setShippingToView(shipping.id)" *ngIf="shipping.guia && shipping.estado === 'en_transito'"
        class="font-bold text-sm text-purple-600 mr-4">
        <fa-icon [icon]="faTruck" class="text-purple-500 mr-1"></fa-icon>
        Ver Guia
      </button>
      <button (click)="openUpdateStatusModal()"
        class="flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-5 rounded-lg shadow hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 transition-all duration-200 min-w-[180px] justify-center">
        <fa-icon [icon]="faEdit"></fa-icon>
        <span>Actualizar Estado</span>
      </button>
    </div>
  </div>
  }
</ng-template>


@if (isUpdateStatusModalOpen) {
<app-update-status-modal [isOpen]="isUpdateStatusModalOpen" [isSubmitting]="isSubmitting"
  [availableStatuses]="availableStatuses" [updateStatusPayload]="updateStatusPayload"
  [guiaImagePreview]="guiaImagePreview" [fileError]="fileError" (close)="closeUpdateStatusModal()"
  (submit)="handleUpdateStatusSubmit($event)" (fileSelected)="onFileSelected($event)">
</app-update-status-modal>
}


@if (idShippingToView){

<app-shipping-viewer [shippingId]="idShippingToView" (close)="closeShippingViewer()">

</app-shipping-viewer>
}