<div class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4 sm:p- lg:p-8">
  <app-header-crud titulo="Envíos" descripcion="Gestiona y actualiza los envíos." textoBotonActualizar="Refrescar"
    placeholderInput="Buscar por Orden, Guía o Transportadora..." [filterByStatus]="true"
    [filterStatusValues]="['preparando', 'en_transito', 'entregado', 'fallido']" (actualizar)="loadShippings()"
    (clearFilters)="handleClearFilters()" (filterChange)="handleFilterChange($event)">
  </app-header-crud>

  <main class="flex p-2 flex-col lg:flex-row h-[calc(100vh-140px)] overflow-hidden mt-6">
    <div class="w-full lg:w-1/3 xl:w-1/2 overflow-y-auto pr-3 lg:border-r lg:border-gray-200">
      @if (isLoading) {
      <div class="flex items-center justify-center h-64">
        <fa-icon [icon]="faCircleNotch" size="3x" class="text-violet-500 animate-spin"></fa-icon>
      </div>
      } @else if (error) {
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
        <div class="flex items-center gap-3">
          <fa-icon [icon]="faExclamationTriangle"></fa-icon>
          <p class="font-bold">{{ error }}</p>
        </div>
      </div>
      } @else if (!shippings.length) {
      <div class="text-center text-gray-400 p-8">
        <fa-icon [icon]="faEye" size="3x" class="mb-3"></fa-icon>
        <p class="font-semibold">No se encontraron envíos</p>
        <p class="text-sm">Intenta con otros filtros o recarga la lista.</p>
      </div>
      } @else {
      <div class="space-y-3">
        @for (shipping of shippings; track shipping.id) {
        <div (click)="selectShipping(shipping)" [ngClass]="{
            'bg-violet-50 border-violet-500 shadow-md scale-[1.02]':
              selectedShipping?.id === shipping.id,
            'bg-white border-gray-200 hover:border-violet-400 hover:shadow-sm':
              selectedShipping?.id !== shipping.id
          }" class="p-4 border rounded-lg cursor-pointer transition-all duration-300">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500">Orden: {{ shipping.order_id }}</p>
              <p class="font-bold text-gray-800">
                {{ shipping.transportadora }}
              </p>
            </div>
            <span [ngClass]="getStatusInfo(shipping.estado).color"
              class="flex items-center gap-2 text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap">
              <fa-icon [icon]="getStatusInfo(shipping.estado).icon"></fa-icon>
              {{ getStatusInfo(shipping.estado).label }}
            </span>
          </div>
          <p class="text-xs text-gray-400 mt-2">Guía: {{ shipping.guia }}</p>
        </div>
        }
      </div>
      }
    </div>

    <div class="w-full lg:w-2/3 xl:w-3/4 overflow-y-auto pl-3 hidden lg:block">
      @if (selectedShipping && !isMobile) {
      <ng-container *ngTemplateOutlet="shippingDetails; context: { shipping: selectedShipping }"></ng-container>
      } @else {
      <div
        class="flex items-center justify-center h-full bg-white/60 border-2 border-dashed border-gray-300 rounded-lg">
        <div class="text-center text-gray-500">
          <fa-icon [icon]="faEye" size="4x" class="mb-4"></fa-icon>
          <p class="text-xl font-semibold">Selecciona un envío</p>
          <p>Elige un envío de la lista para ver sus detalles aquí.</p>
        </div>
      </div>
      }
    </div>
  </main>
</div>

@if (isDetailsModalOpen && isMobile) {
<div
  class="fixed inset-0 bg-black/60 w-full z-40 flex items-center p-4 animate__animated animate__fadeIn animate__faster">
  <div
    class="relative max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-xl animate__animated animate__slideInUp animate__faster">
    <button (click)="closeDetailsModal()"
      class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors z-50">
      <fa-icon [icon]="faTimes" size="lg"></fa-icon>
    </button>

    <ng-container *ngTemplateOutlet="shippingDetails; context: { shipping: selectedShipping }"></ng-container>
  </div>
</div>
}


<ng-template #shippingDetails let-shipping="shipping">
  @if(shipping) {
  <div class="bg-white py-6 rounded-lg transition-all duration-300">

    <div class="flex bg-white p-4 flex-col sm:flex-row sticky top-0 z-40 mx-0 justify-between sm:items-center pb-4 border-b border-gray-200 mb-6 scroll-purple">
      <div class="bg-white">
        <h2 class="text-2xl font-bold text-violet-700">
          Detalles del Envío
        </h2>
        <p class="text-sm text-gray-500">
          Guía: {{ shipping.guia }}
        </p>
      </div>
      <div class="mt-4 sm:mt-0 text-left sm:text-right">
        <p class="text-sm text-gray-600">Fecha entrega estimada</p>
        <p class="font-semibold text-lg">
          {{ shipping.fechaEstimada | date: 'longDate' }}
        </p>
        <p *ngIf="shipping?.estado =='entregado'" class="text-sm text-gray-600">Fecha entrega real</p>
        <p *ngIf="shipping?.estado =='entregado'" class="font-semibold text-lg">
          {{ shipping.fechaEntregaReal | date: 'longDate' }}
        </p>
      </div>
    </div>

    <div class="grid px-6 grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
      <div><span class="font-semibold">ID Orden:</span> {{ shipping.order_id }}</div>
      <div><span class="font-semibold">Transportadora:</span> {{ shipping.transportadora }}</div>
      <div [ngClass]="getStatusInfo(shipping.estado).color" class="flex items-center gap-2">
        <fa-icon [icon]="getStatusInfo(shipping.estado).icon" size="lg"></fa-icon>
        <span class="font-semibold text-lg">{{ getStatusInfo(shipping.estado).label }}</span>
      </div>
      @if (shipping.fechaEntregaReal) {
      <div><span class="font-semibold">Entregado el:</span> {{ shipping.fechaEntregaReal | date: 'longDate' }}</div>
      }
    </div>

    <h3 class="text-xl px-6 font-bold text-gray-800 mb-4">Historial</h3>
    <div class="relative pl-14 border-l-2 border-violet-200 space-y-8">
      @for (event of shipping.historial; track event.timestamp) {
      <div class="relative">
        <div class="absolute -left-[34px] top-1 h-4 w-4 rounded-full"
          [ngClass]="getStatusInfo(event.status).color.replace('text-', 'bg-')"></div>
        <p class="text-sm text-gray-500">
          {{ event.timestamp | date: 'medium' }}
        </p>
        <p class="font-semibold" [ngClass]="getStatusInfo(event.status).color">
          {{ getStatusInfo(event.status).label }}
        </p>
        <p class="text-gray-700">{{ event.description }}</p>
      </div>
      }
    </div>

    <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end">
      <button (click)="openUpdateStatusModal()"
        class="flex items-center gap-2 bg-violet-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-violet-500 transition-all duration-300">
        <fa-icon [icon]="faEdit"></fa-icon>
        Actualizar Estado
      </button>
    </div>
  </div>
  }
</ng-template>


@if (isUpdateStatusModalOpen) {
<app-update-status-modal [isOpen]="isUpdateStatusModalOpen" [isSubmitting]="isSubmitting"
  [availableStatuses]="availableStatuses" [updateStatusPayload]="updateStatusPayload"
  [guiaImagePreview]="guiaImagePreview" [fileError]="fileError" (close)="closeUpdateStatusModal()"
  (submit)="handleUpdateStatusSubmit($event)" (fileSelected)="onFileSelected($event)">
</app-update-status-modal>
}
