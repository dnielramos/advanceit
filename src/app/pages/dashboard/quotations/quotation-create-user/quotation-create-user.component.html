<div class="bg-slate-50 min-h-screen">
  <div class="container mx-auto p-4 md:p-8 max-w-6xl animate__animated animate__fadeIn">

    <div class="flex items-center text-slate-500 mb-10 p-4 bg-white rounded-xl shadow-sm">
      <div class="flex-1 flex flex-col items-center relative">
        <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold transition-colors duration-300 z-10"
             [ngClass]="currentStep >= 1 ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-200 text-slate-400'">1</div>
        <span class="text-sm mt-2 font-semibold" [ngClass]="{'text-purple-600': currentStep >= 1}">Cliente</span>
      </div>
      <div class="flex-1 border-t-2 transition-colors duration-300" [ngClass]="currentStep >= 2 ? 'border-purple-500' : 'border-slate-300'"></div>
      <div class="flex-1 flex flex-col items-center">
        <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold transition-colors duration-300 z-10"
             [ngClass]="currentStep >= 2 ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-200 text-slate-400'">2</div>
        <span class="text-sm mt-2 font-semibold" [ngClass]="{'text-purple-600': currentStep >= 2}">Productos</span>
      </div>
      <div class="flex-1 border-t-2 transition-colors duration-300" [ngClass]="currentStep >= 3 ? 'border-purple-500' : 'border-slate-300'"></div>
      <div class="flex-1 flex flex-col items-center">
        <div class="w-10 h-10 flex items-center justify-center rounded-full font-bold transition-colors duration-300 z-10"
             [ngClass]="currentStep >= 3 ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-200 text-slate-400'">3</div>
        <span class="text-sm mt-2 font-semibold" [ngClass]="{'text-purple-600': currentStep >= 3}">Resumen</span>
      </div>
    </div>

    <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()">
      <div *ngIf="currentStep === 1" class="animate__animated animate__fadeInUp animate__faster">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200">
          <h2 class="text-3xl font-bold text-slate-800 mb-2">Información del Cliente</h2>
          <p class="text-slate-500 mb-8">Selecciona o confirma los datos para iniciar la cotización.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">

            <ng-container *ngIf="userRole === Role.Admin">
              <div>
                <label for="company_id" class="block text-sm font-semibold text-slate-700 mb-1">Empresa Asociada</label>
                <select id="company_id" formControlName="company_id" class="mt-1 p-3 w-full rounded-lg border-slate-300 shadow-sm focus:ring-purple-500 focus:border-purple-500 transition">
                  <option [ngValue]="null" disabled>-- Selecciona una empresa --</option>
                  <option *ngFor="let company of companies$ | async" [ngValue]="company.id">{{ company.razon_social }}</option>
                </select>
              </div>
              <div>
                <label for="user_id" class="block text-sm font-semibold text-slate-700 mb-1">Usuario Asignado</label>
                <select id="user_id" formControlName="user_id" class="mt-1 p-3 w-full rounded-lg border-slate-300 shadow-sm focus:ring-purple-500 focus:border-purple-500 transition">
                  <option [ngValue]="null" disabled>-- Selecciona un usuario --</option>
                  <option *ngFor="let user of filteredUsers$ | async" [ngValue]="user.id">{{ user.name }} ({{ user.email }})</option>
                </select>
                <div *ngIf="quotationForm.get('user_id')?.value && selectedCompany" class="text-green-600 text-xs mt-1">
                  ✓ Usuario seleccionado automáticamente
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="userRole === Role.User && selectedUser && selectedCompany">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">Tu Empresa</label>
                <input type="text" [value]="selectedCompany.razon_social" class="mt-1 p-3 w-full bg-slate-100 rounded-lg border-slate-300 cursor-not-allowed" disabled>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">Tu Usuario</label>
                <input type="text" [value]="selectedUser.name" class="mt-1 p-3 w-full bg-slate-100 rounded-lg border-slate-300 cursor-not-allowed" disabled>
              </div>
            </ng-container>

            <div>
              <label for="validity_days" class="block text-sm font-semibold text-slate-700 mb-1">Validez de la Oferta</label>
              <select id="validity_days" formControlName="validity_days" class="mt-1 p-3 w-full rounded-lg border-slate-300 shadow-sm focus:ring-purple-500 focus:border-purple-500 transition">
                <option [ngValue]="15">15 días</option>
                <option [ngValue]="30">30 días</option>
              </select>
            </div>
            <div>
              <label for="term" class="block text-sm font-semibold text-slate-700 mb-1">Condiciones de Pago</label>
              <input *ngIf="userRole === Role.User" type="text" formControlName="term" class="mt-1 p-3 w-full bg-slate-100 rounded-lg border-slate-300 cursor-not-allowed" [disabled]="true" [value]="selectedCompany?.condiciones_pago === '0' ? 'Contado' : selectedCompany?.condiciones_pago + ' días de crédito'">
              <select *ngIf="userRole === Role.Admin" id="term" formControlName="term" [disabled]="!!selectedCompany" class="mt-1 p-3 w-full rounded-lg border-slate-300 shadow-sm focus:ring-purple-500 focus:border-purple-500 transition disabled:bg-slate-100 disabled:cursor-not-allowed">
                <option value="0">Contado</option>
                <option value="30">Crédito 30 días</option>
                <option value="60">Crédito 60 días</option>
              </select>
              <div *ngIf="userRole === Role.Admin && selectedCompany" class="text-blue-600 text-xs mt-1">
                ✓ Términos establecidos automáticamente desde la empresa
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="currentStep === 2" class="animate__animated animate__fadeInUp animate__faster">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <div>
            <h2 class="text-3xl font-bold text-slate-800">Productos de la Cotización</h2>
            <p class="text-slate-500 mt-1">Añade o ajusta los productos para el cliente.</p>
          </div>
          <button type="button" (click)="openProductModal()" class="flex-shrink-0 w-full md:w-auto flex items-center justify-center gap-2 px-5 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
            <fa-icon [icon]="['fas', 'plus']"></fa-icon>Añadir más productos
          </button>
        </div>
        <div formArrayName="details" class="space-y-4">
          <p *ngIf="details.length === 0" class="text-center text-slate-500 py-12 bg-white rounded-2xl shadow-lg border border-slate-200">
            Aún no has añadido productos. <br> ¡Haz clic en "Añadir más productos" para empezar!
          </p>
          <div *ngFor="let detail of details.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i" class="flex flex-col md:flex-row items-center p-4 bg-white rounded-2xl shadow-lg border border-slate-200 gap-5 transition-shadow hover:shadow-xl">
            <img [src]="detail.value.product_image || 'https://via.placeholder.com/150'" alt="Imagen del producto" class="w-28 h-28 object-contain rounded-xl flex-shrink-0">
            <div class="flex-grow text-center md:text-left">
              <h4 class="font-bold text-slate-800 text-lg max-w-[150px] sm:max-w-[200px] truncate">{{ detail.value.product_name }}</h4>
              <p class="text-sm text-slate-600 mt-1 max-w-md line-clamp-2 overflow-hidden">{{ detail.value.product_description }}</p>
            </div>
            <div class="flex items-center gap-4 flex-wrap justify-center">
              <div>
                <label class="block text-xs font-medium text-slate-600 text-center mb-1">Cantidad</label>
                <input type="number" formControlName="quantity" class="w-24 text-center p-2 border-slate-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 text-center mb-1">Precio Unit.</label>
                <input type="number" formControlName="unit_price" class="w-36 text-right p-2 border-slate-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" [disabled]="true">
              </div>
              <div class="text-center">
                  <p class="text-xs font-medium text-slate-600">Subtotal</p>
                  <p class="font-bold text-purple-600 text-lg mt-1">
                    {{ (detail.value.quantity * detail.value.unit_price) | currency:'COP':'symbol':'1.0-0' }}
                  </p>
              </div>
            </div>
            <button (click)="removeDetail(i)" type="button" class="p-3 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Eliminar producto">
              <fa-icon [icon]="['fas', 'trash-alt']" size="lg"></fa-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="currentStep === 3" class="animate__animated animate__fadeInUp animate__faster">
        <h2 class="md:text-2xl text-md font-bold text-slate-800 mb-6 flex items-center gap-3">
          <fa-icon [icon]="['fas', 'file-invoice-dollar']"></fa-icon>Resumen de la Cotización
        </h2>
        <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
          <div class="p-6 md:p-10">
            <div class="flex flex-col sm:flex-row justify-between items-center md:items-start pb-6 border-b border-slate-200">
              <div class="flex flex-col md:flex-row items-center gap-4 mb-4 sm:mb-0">
                  <img src="assets/images/logo.png" alt="Logo Advance" class="h-14">
                  <div>
                    <h3 class="text-md md:text-2xl text-center font-extrabold text-slate-900">Advance Technology Projects</h3>
                    <p class="text-sm text-slate-500">NIT - 900562155 | www.advanceit.co</p>
                  </div>
              </div>
              <div class="text-left sm:text-right">
                <h3 class="text-2xl font-bold text-slate-800">COTIZACIÓN</h3>
                <p class="text-sm text-slate-500 mt-1">Fecha: {{ currentDate | date:'d MMMM, y' }}</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
              <div>
                <h4 class="font-semibold text-slate-500 uppercase tracking-wider text-xs mb-2">Cliente</h4>
                <p class="font-bold text-slate-900 text-xl">{{ selectedCompany?.razon_social }}</p>
                <p class="text-slate-600 mt-1">Atención: {{ selectedUser?.name }}</p>
                <p class="text-slate-600">{{ selectedUser?.email }}</p>
              </div>
              <div class="md:text-right">
                <h4 class="font-semibold text-slate-500 uppercase tracking-wider text-xs mb-2">Condiciones</h4>
                <p class="text-slate-700"><strong>Validez:</strong> {{ quotationForm.getRawValue().validity_days }} días</p>
                <p class="text-slate-700"><strong>Pago:</strong> {{ esOrdenDeContado ? 'De Contado' : selectedCompany?.condiciones_pago + ' días de crédito' }}</p>
              </div>
            </div>
          </div>
          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Producto</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">Cant.</th>
                  <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Precio Unit.</th>
                  <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Subtotal</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                <tr *ngFor="let detail of details.controls">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <p class="font-semibold text-slate-900">{{ detail.value.product_name }}</p>
                    <p class="text-xs text-slate-500 max-w-xs truncate">{{ detail.value.product_description }}</p>
                  </td>
                  <td class="px-6 py-4 text-center text-slate-700">{{ detail.value.quantity }}</td>
                  <td class="px-6 py-4 text-right text-slate-700">{{ detail.value.unit_price | currency:'COP':'symbol':'1.0-0' }}</td>
                  <td class="px-6 py-4 text-right font-semibold text-slate-800">{{ (detail.value.quantity * detail.value.unit_price) | currency:'COP':'symbol':'1.0-0' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="bg-slate-50 p-6 md:p-10">
              <div class="flex flex-col md:flex-row justify-between gap-8">
                  <div class="w-full md:w-1/2">
                      <h4 class="font-semibold text-slate-800 mb-3">Estado del Crédito</h4>
                      <div *ngIf="esOrdenDeContado" class="p-4 bg-blue-100 text-purple-800 rounded-lg border border-blue-200">
                          <p class="font-bold">Pago de Contado</p>
                          <p class="text-sm mt-1">Esta orden no requiere validación de crédito.</p>
                      </div>
                      <div *ngIf="!esOrdenDeContado && creditoCubreOrden" class="p-4 bg-green-100 text-green-800 rounded-lg border border-green-200">
                          <fa-icon [icon]="['fas', 'check-circle']" class="text-2xl"></fa-icon>
                          <p class="text-sm mt-1">El crédito disponible de <strong>{{ creditoDisponible | currency:'COP':'symbol':'1.0-0' }}</strong> es suficiente.</p>
                      </div>
                      <div *ngIf="!esOrdenDeContado && !creditoCubreOrden" class="p-4 bg-red-100 text-red-800 rounded-lg border border-red-200">
                          <p class="font-bold">Crédito Insuficiente</p>
                          <p class="text-sm mt-1">El total excede el crédito de <strong>{{ creditoDisponible | currency:'COP':'symbol':'1.0-0' }}</strong>.</p>
                      </div>
                  </div>
                  <div class="w-full md:w-1/2 max-w-sm ml-auto space-y-2 text-slate-700">
                      <div class="flex justify-between"><span>Subtotal Productos:</span> <span>{{ subtotal | currency:'COP':'symbol':'1.0-0' }}</span></div>
                      <div class="flex justify-between text-red-600"><span>Descuentos ({{ totalDescuentos }}%):</span> <span>- {{ valorBaseDescuentos | currency:'COP':'symbol':'1.0-0' }}</span></div>
                      <div class="flex justify-between"><span>Valor Logística:</span> <span>+ {{ valorLogistica | currency:'COP':'symbol':'1.0-0' }}</span></div>
                      <div class="border-t my-2 border-slate-200"></div>
                      <div class="flex justify-between font-semibold"><span>Base Gravable (IVA):</span> <span>{{ baseParaIVA | currency:'COP':'symbol':'1.0-0' }}</span></div>
                      <div class="flex justify-between"><span>IVA (19%):</span> <span>+ {{ valorIVA | currency:'COP':'symbol':'1.0-0' }}</span></div>
                      <div class="border-t-2 my-2 border-slate-300"></div>
                      <div class="flex justify-between items-center text-slate-900">
                          <span class="font-bold text-md md:text-xl">TOTAL:</span>
                          <span class="font-bold text-purple-600 text-2xl">{{ granTotal | currency:'COP':'symbol':'1.0-0' }}</span>
                      </div>
                  </div>
              </div>
          </div>
          <div class="border-t border-slate-200 bg-white px-6 md:px-10 py-5">
              <p class="text-[10px] md:text-[12px] text-center text-slate-500">
                  Gracias por su interés. Si tiene alguna pregunta, no dude en contactarnos.
              </p>
          </div>
        </div>
    </div>
    </form>

    <div class="flex justify-between mt-10 pt-6 border-t border-slate-300">
      <button *ngIf="currentStep > 1" (click)="prevStep()" type="button" class="flex items-center gap-2 px-6 py-3 text-slate-700 bg-white rounded-lg hover:bg-slate-100 transition-colors border border-slate-300 shadow-sm">
        <fa-icon [icon]="['fas', 'arrow-left']"></fa-icon> Anterior
      </button>
      <div *ngIf="currentStep === 1" class="flex-grow"></div>
      <button *ngIf="currentStep < 3" (click)="nextStep()" type="button" [disabled]="!isStepValid(currentStep)" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
        <span *ngIf="currentStep === 1 && userRole === Role.Admin && (!selectedUser || !selectedCompany) && quotationForm.get('company_id')?.value && quotationForm.get('user_id')?.value">
          <fa-icon [icon]="['fas', 'spinner']" class="animate-spin"></fa-icon> Cargando datos...
        </span>
        <span *ngIf="!(currentStep === 1 && userRole === Role.Admin && (!selectedUser || !selectedCompany) && quotationForm.get('company_id')?.value && quotationForm.get('user_id')?.value)">
          Siguiente <fa-icon [icon]="['fas', 'arrow-right']"></fa-icon>
        </span>
      </button>
      <button *ngIf="currentStep === 3" (click)="onSubmit()" type="submit" [disabled]="isLoading || quotationForm.invalid || !creditoCubreOrden" class="px-8 py-3 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
        <div *ngIf="isLoading" class="flex items-center gap-2">
          <fa-icon [icon]="['fas', 'spinner']" class="animate-spin"></fa-icon> Creando...
        </div>
        <div *ngIf="!isLoading" class="flex items-center gap-2">
          <fa-icon [icon]="['fas', 'save']"></fa-icon> Confirmar y Guardar
        </div>
      </button>
    </div>
  </div>
</div>

<lib-toastify-toast-container></lib-toastify-toast-container>
