<div class="flex flex-col hflexy z-1000 mt-6 p-6 space-y-6 animate__animated animate__fadeIn animate__fast">

  <div class="flex items-center justify-between text-gray-500 mb-6">
    <div class="flex-1 flex flex-col items-center">
      <div [ngClass]="{'bg-purple-600': currentStep >= 1, 'bg-gray-300': currentStep < 1}"
        class="w-8 h-8 flex items-center justify-center rounded-full text-white font-bold transition-colors duration-300">
        1
      </div>
      <span class="text-sm mt-2">Usuarios</span>
    </div>
    <div class="flex-1 border-t-2 transition-colors duration-300"
      [ngClass]="{'border-purple-600': currentStep >= 2, 'border-gray-300': currentStep < 2}"></div>
    <div class="flex-1 flex flex-col items-center">
      <div [ngClass]="{'bg-purple-600': currentStep >= 2, 'bg-gray-300': currentStep < 2}"
        class="w-8 h-8 flex items-center justify-center rounded-full text-white font-bold transition-colors duration-300">
        2
      </div>
      <span class="text-sm mt-2">Productos</span>
    </div>
    <div class="flex-1 border-t-2 transition-colors duration-300"
      [ngClass]="{'border-purple-600': currentStep >= 3, 'border-gray-300': currentStep < 3}"></div>
    <div class="flex-1 flex flex-col items-center">
      <div [ngClass]="{'bg-purple-600': currentStep >= 3, 'bg-gray-300': currentStep < 3}"
        class="w-8 h-8 flex items-center justify-center rounded-full text-white font-bold transition-colors duration-300">
        3
      </div>
      <span class="text-sm mt-2">Confirma</span>
    </div>
  </div>

  <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()">

    <lib-toastify-toast-container></lib-toastify-toast-container>

    <div *ngIf="currentStep === 1" class="animate__animated animate__fadeInRight">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Información Principal</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="company_id" class="block text-sm font-medium text-gray-700">ID de Empresa</label>
          <select id="company_id" formControlName="company_id"
            class="p-2 w-full rounded-md border border-gray-300 shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
            <option [ngValue]="''" disabled>-- Selecciona una empresa --</option>
            <option *ngFor="let company of companies$ | async" [ngValue]="company.id">
              {{ company.razon_social }}
            </option>
          </select>
          <div
            *ngIf="quotationForm.get('company_id')?.invalid && (quotationForm.get('company_id')?.dirty || quotationForm.get('company_id')?.touched)"
            class="text-red-500 text-sm mt-1">Necesitas elegir una empresa.</div>
        </div>
        <div>
          <label for="user_id" class="block text-sm font-medium text-gray-700">ID de Usuario</label>
          <select id="user_id" formControlName="user_id"
            [disabled]="isAdmin"
            class="p-2 w-full rounded-md border border-gray-300 shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed">
            <option [ngValue]="''" disabled>-- Selecciona un usuario --</option>
            <option *ngFor="let user of filteredUsers$ | async" [ngValue]="user.id">
              {{ user.name }} ({{ user.email }})
            </option>
          </select>
          <div
            *ngIf="quotationForm.get('user_id')?.invalid && (quotationForm.get('user_id')?.dirty || quotationForm.get('user_id')?.touched)"
            class="text-red-500 text-sm mt-1">Necesitas elegir un usuario.</div>
          <div *ngIf="isAdmin && quotationForm.get('user_id')?.value" class="text-blue-500 text-sm mt-1">
            ✓ Usuario seleccionado automáticamente (campo bloqueado para admin)
          </div>
          <div *ngIf="!isAdmin && quotationForm.get('user_id')?.value && company" class="text-green-500 text-sm mt-1">
            ✓ Usuario seleccionado automáticamente (puedes cambiarlo si es necesario)
          </div>
        </div>
        <div>
          <label for="validity_days" class="block text-sm font-medium text-gray-700">Días de Validez</label>
          <select id="validity_days" formControlName="validity_days"
            class="p-2 w-full rounded-md border border-gray-300 shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
            <option [ngValue]="''" disabled>-- Cuando expira la cotización? --</option>
            <option [ngValue]="15">15 días</option>
            <option [ngValue]="30">30 días</option>
          </select>
          <div
            *ngIf="quotationForm.get('validity_days')?.invalid && (quotationForm.get('validity_days')?.dirty || quotationForm.get('validity_days')?.touched)"
            class="text-red-500 text-sm mt-1">Necesitas elegir cuantos dias.</div>
        </div>
        <div>
          <label for="term" class="block text-sm font-medium text-gray-700">Término</label>
          <select id="term" formControlName="term"
            [disabled]="!!company"
            class="p-2 w-full rounded-md border border-gray-300 shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed">
            <option [ngValue]="''" disabled>-- Cuanto plazo para el pago? --</option>
            <option [ngValue]="'30'">30 días</option>
            <option [ngValue]="'60'">60 días</option>
          </select>
          <div
            *ngIf="quotationForm.get('term')?.invalid && (quotationForm.get('term')?.dirty || quotationForm.get('term')?.touched)"
            class="text-red-500 text-sm mt-1">Necesitas elegir cuanto plazo para el pago.</div>
          <div *ngIf="company" class="text-blue-500 text-sm mt-1">Término establecido automáticamente desde la empresa</div>
        </div>
      </div>
    </div>

    <div *ngIf="currentStep === 2" class="animate__animated animate__fadeInRight">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Añadir Productos</h3>
      <div formArrayName="details" class="space-y-4">
        <div *ngFor="let detail of details.controls; let i = index" [formGroupName]="i"
          class="p-4 border border-gray-200 rounded-md bg-gray-50 flex flex-col md:flex-row md:items-end md:space-x-4 animate__animated animate__fadeIn">
          <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Producto ID</label>
              <input type="text" formControlName="product_id"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
              <div
                *ngIf="details.at(i).get('product_id')?.invalid && (details.at(i).get('product_id')?.dirty || details.at(i).get('product_id')?.touched)"
                class="text-red-500 text-sm mt-1">Campo requerido.</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Nombre</label>
              <input type="text" formControlName="product_name"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
              <div
                *ngIf="details.at(i).get('product_name')?.invalid && (details.at(i).get('product_name')?.dirty || details.at(i).get('product_name')?.touched)"
                class="text-red-500 text-sm mt-1">Campo requerido.</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Cantidad</label>
              <input type="number" formControlName="quantity" readonly
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
              <div
                *ngIf="details.at(i).get('quantity')?.invalid && (details.at(i).get('quantity')?.dirty || details.at(i).get('quantity')?.touched)"
                class="text-red-500 text-sm mt-1">Campo requerido y > 0.</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Precio</label>
              <input type="number" formControlName="unit_price" readonly
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
              <div
                *ngIf="details.at(i).get('unit_price')?.invalid && (details.at(i).get('unit_price')?.dirty || details.at(i).get('unit_price')?.touched)"
                class="text-red-500 text-sm mt-1">Campo requerido y >= 0.</div>
            </div>
          </div>
          <div class="mt-4 md:mt-0">
            <button (click)="removeDetail(i)" type="button"
              class="p-2 text-red-500 hover:bg-red-500 hover:text-white rounded-full transition-colors duration-200"
              title="Eliminar ítem">
              <fa-icon [icon]="['fas', 'trash-alt']"></fa-icon>
              Quitar
            </button>
          </div>
        </div>
      </div>
      <button type="button" (click)="openProductModal()"
        class="flex items-center justify-center w-full py-2 border-2 border-dashed border-gray-300 rounded-md text-gray-500 hover:text-purple-600 hover:border-purple-400 transition-colors duration-200 mt-4">
        <fa-icon [icon]="['fas', 'plus']" class="mr-2"></fa-icon>Añadir Ítems
      </button>
    </div>

    <div *ngIf="currentStep === 3" class="animate__animated animate__fadeInRight">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Revisar y Confirmar</h3>
      
      <!-- Indicador de carga del preview -->
      <div *ngIf="isLoadingPreview" class="flex items-center justify-center p-6">
        <fa-icon [icon]="['fas', 'spinner']" class="mr-2 animate-spin text-purple-600 text-3xl"></fa-icon>
        <span class="text-gray-600">Calculando cotización...</span>
      </div>

      <div *ngIf="!isLoadingPreview && previewData" class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">

        <div class="flex items-center justify-center mb-2">
          <img src="logo.png" alt="logo-advance" class="w-34 h-14 object-contain">
        </div>
        <div class="flex flex-col items-center mb-4">
          <p class="text-gray-700">Advance Technology Projects</p>
          <p class="text-gray-700">NIT - 900562155</p>
          <p class="text-gray-700">www.advanceit.co</p>
        </div>
        <div class="flex justify-between items-center mb-4">
          <p class="text-gray-700">Hoy es {{ hoy }}</p>
        </div>
        <h4 class=" font-bold text-gray-700">Los datos de la Cotización:</h4>
        <ul class="text-gray-600 space-y-1">
          <li><strong>Razon Social:</strong> {{ previewData.company.name }}</li>
          <li><strong>Usuario:</strong> {{ previewData.user.name }}</li>
          <li><strong>Días de Validez:</strong> {{ previewData.validity_days }}</li>
          <li><strong>Fecha de vencimiento:</strong> {{ previewData.expiration_date | date:'dd/MM/yyyy' }}</li>
          <li><strong>Término:</strong> {{ previewData.term }}</li>
          <li><strong>Tipo de pago:</strong> {{ previewData.company.credit?.has_credit ? 'Cupo crédito' : 'Contado/Transferencia' }}</li>
        </ul>

        <!-- Información de Crédito -->
        <div *ngIf="previewData?.company?.credit?.has_credit" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-bold text-blue-900 mb-3">Información de Crédito:</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="flex justify-between">
              <span class="text-blue-700">Crédito Total:</span>
              <span class="font-semibold text-blue-900">${{ previewData?.company?.credit?.total_credit | number:'1.0-0' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-blue-700">Crédito Gastado:</span>
              <span class="font-semibold text-orange-600">${{ previewData?.company?.credit?.spent_credit | number:'1.0-0' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-blue-700">Crédito Disponible:</span>
              <span class="font-semibold text-green-600">${{ previewData?.company?.credit?.available_credit | number:'1.0-0' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-blue-700">Total de esta cotización:</span>
              <span class="font-semibold text-purple-600">${{ previewData?.calculations?.total | number:'1.0-0' }}</span>
            </div>
          </div>
          <div *ngIf="(previewData?.company?.credit?.available_credit || 0) < (previewData?.calculations?.total || 0)" 
               class="mt-3 p-3 bg-red-100 border border-red-300 rounded-md">
            <p class="text-red-700 text-sm font-semibold">⚠️ Advertencia: El total de la cotización excede el crédito disponible.</p>
            <p class="text-red-600 text-xs mt-1">
              Déficit: ${{ ((previewData?.calculations?.total || 0) - (previewData?.company?.credit?.available_credit || 0)) | number:'1.0-0' }}
            </p>
          </div>
          <div *ngIf="(previewData?.company?.credit?.available_credit || 0) >= (previewData?.calculations?.total || 0)" 
               class="mt-3 p-3 bg-green-100 border border-green-300 rounded-md">
            <p class="text-green-700 text-sm font-semibold">✓ Crédito suficiente para esta cotización</p>
            <p class="text-green-600 text-xs mt-1">
              Crédito restante después de esta compra: ${{ ((previewData?.company?.credit?.available_credit || 0) - (previewData?.calculations?.total || 0)) | number:'1.0-0' }}
            </p>
          </div>
        </div>

        <h4 class="font-bold text-gray-700 mt-4">Los productos de la cotización:</h4>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
              <tr>
                <th class="px-4 py-2">Producto</th>
                <th class="px-4 py-2">Cantidad</th>
                <th class="px-4 py-2">Precio Unitario</th>
                <th class="px-4 py-2">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of previewData.products" class="bg-white border-b">
                <td class="px-4 py-2">{{ product.name }}</td>
                <td class="px-4 py-2">{{ product.quantity }}</td>
                <td class="px-4 py-2">${{ product.unit_price | number:'1.0-0' }}</td>
                <td class="px-4 py-2">${{ product.subtotal | number:'1.0-0' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h4 class="font-bold text-gray-700 mt-6">Desglose de Cálculos:</h4>
        <div class="bg-white p-4 rounded-md border border-gray-200 space-y-2">
          <div class="flex justify-between items-center py-2 border-b">
            <span class="text-gray-700">Subtotal Productos:</span>
            <span class="font-semibold">${{ previewData.calculations.subtotal_productos | number:'1.0-0' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b text-red-600">
            <span>Descuento ({{ previewData.calculations.porcentaje_descuento }}%):</span>
            <span class="font-semibold">-${{ previewData.calculations.valor_descuento | number:'1.0-0' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b">
            <span class="text-gray-700">Logística:</span>
            <span class="font-semibold">+${{ previewData.calculations.valor_logistica | number:'1.0-0' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b bg-gray-50">
            <span class="text-gray-700 font-bold">Base Gravable:</span>
            <span class="font-bold">${{ previewData.calculations.base_gravable | number:'1.0-0' }}</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b">
            <span class="text-gray-700">IVA ({{ previewData.calculations.porcentaje_iva }}%):</span>
            <span class="font-semibold">+${{ previewData.calculations.valor_iva | number:'1.0-0' }}</span>
          </div>
          <div class="flex justify-between items-center py-3 bg-purple-50 rounded-md px-2">
            <span class="text-purple-900 font-bold text-lg">TOTAL:</span>
            <span class="text-purple-600 font-bold text-xl">${{ previewData.calculations.total | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>

      <!-- Mensaje si no hay preview -->
      <div *ngIf="!isLoadingPreview && !previewData" class="p-6 bg-yellow-50 rounded-lg border border-yellow-200">
        <p class="text-yellow-800">No se pudo cargar el preview de la cotización. Por favor, regrese al paso anterior.</p>
      </div>
    </div>
  </form>

  <div class="flex justify-between py-6 border-t">
    <button *ngIf="currentStep > 1" (click)="prevStep()" type="button"
      class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-200 transition-colors duration-200">
      <fa-icon [icon]="['fas', 'arrow-left']" class="mr-2"></fa-icon> Anterior
    </button>

    <div class="flex-grow"></div>

    <button *ngIf="currentStep < 3" (click)="nextStep()" type="button" [disabled]="!isStepValid(currentStep)"
      class="flex items-center px-6 py-2 rounded-md font-semibold text-white bg-purple-600 hover:bg-purple-700 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
      Siguiente <fa-icon [icon]="['fas', 'arrow-right']" class="ml-2"></fa-icon>
    </button>

    <button *ngIf="currentStep === 3" (click)="onSubmit()" type="submit" [disabled]="isLoading"
      class="px-6 py-2 rounded-md font-semibold text-white bg-purple-600 hover:bg-purple-700 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
      <div *ngIf="isLoading" class="flex items-center">
        <fa-icon [icon]="['fas', 'spinner']" class="mr-2 animate-spin"></fa-icon> Creando...
      </div>
      <div *ngIf="!isLoading">
        <fa-icon [icon]="['fas', 'save']" class="mr-2"></fa-icon> Confirmar y Guardar
      </div>
    </button>
  </div>
</div>