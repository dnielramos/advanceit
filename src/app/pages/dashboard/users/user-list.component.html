<div class="bg-slate-100 font-sans">
  <div class="container min-w-full">
    <div class="rounded-2xl shadow-xl p-6 flex flex-col h-[calc(100vh-4rem)] bg-slate-50">
      <!-- HEADER CRUD ESTÁNDAR -->
      <app-header-crud titulo="Usuarios" descripcion="Gestiona los usuarios del sistema"
        textoBotonNuevo="Agregar Usuario" textoBotonActualizar="Actualizar" [filterByStatus]="true"
        [filterStatusValues]="availableRoles" placeholderInput="Buscar por nombre o email..." [showViewToggle]="true"
        [currentView]="state().viewMode" (crear)="openAddModal()" (actualizar)="loadUsers()"
        (filterChange)="handleFilterChange($event)" (clearFilters)="handleClearFilters()"
        (viewChange)="handleViewChange($event)">
      </app-header-crud>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="flex-grow overflow-y-auto pr-2 pt-6 scroll-purple">

        <!-- Grid View -->
        @if (state().viewMode === 'grid') {
        <!-- Loading State (Skeleton) -->
        @if (state().loading) {
        <app-skeleton-card [count]="8"></app-skeleton-card>
        }

        <!-- Actual Content -->
        @if (!state().loading && !state().error && filteredUsers().length > 0) {
        <div
          class="grid gap-6 grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 animate__animated animate__fadeInUp">
          @for (user of filteredUsers(); track user.id) {
          <div
            class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md hover:border-purple-200 transition-all duration-300 group">
            <div class="flex items-center space-x-4">
              <div class="relative">
                <img [src]="user.picture || 'https://placehold.co/150x150/663399/FFFFFF?text=' + user.name.charAt(0)"
                  alt="Foto de {{ user.name }}"
                  class="w-16 h-16 rounded-full object-cover border-2 border-purple-100 group-hover:border-purple-400 transition-colors" />
              </div>

              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-bold text-gray-900 truncate group-hover:text-purple-700 transition-colors">
                  {{ user.name }}
                </h3>
                <p class="text-sm text-gray-500 truncate mb-1">
                  {{ user.email }}
                </p>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize"
                  [ngClass]="{
                            'bg-purple-100 text-purple-800': user.type === 'admin',
                            'bg-blue-100 text-blue-800': user.type === 'user',
                            'bg-orange-100 text-orange-800': user.type === 'cashier',
                            'bg-gray-100 text-gray-800': user.type === 'warehouse'
                          }">
                  {{ user.type }}
                </span>
              </div>
            </div>

            <div
              class="mt-5 pt-4 border-t border-gray-100 flex justify-end space-x-2 opacity-80 group-hover:opacity-100 transition-opacity">
              <button (click)="viewUser(user)"
                class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Ver detalles">
                <fa-icon [icon]="faEye"></fa-icon>
              </button>
              <button (click)="editUser(user)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                title="Editar usuario">
                <fa-icon [icon]="faPen"></fa-icon>
              </button>
            </div>
          </div>
          }
        </div>
        }
        }

        <!-- List View -->
        @if (state().viewMode === 'list') {
        <!-- Loading State (Skeleton) -->
        @if (state().loading) {
        <app-skeleton-table [rowCount]="8" [columnCount]="4"></app-skeleton-table>
        }

        <!-- Actual Content -->
        @if (!state().loading && !state().error && filteredUsers().length > 0) {
        <div
          class="inline-block w-full border border-gray-200 rounded-lg overflow-hidden shadow-sm animate__animated animate__fadeIn">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-semibold">Usuario</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Email</th>
                <th class="px-6 py-4 text-left text-sm font-semibold">Rol</th>
                <th class="px-6 py-4 text-right text-sm font-semibold">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
              @for (user of filteredUsers(); track user.id) {
              <tr class="hover:bg-purple-50 transition-colors group">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <img
                      [src]="user.picture || 'https://placehold.co/150x150/663399/FFFFFF?text=' + user.name.charAt(0)"
                      class="h-10 w-10 rounded-full object-cover border border-gray-200" alt="">
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900 group-hover:text-purple-700 transition-colors">{{
                        user.name }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ user.email }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize"
                    [ngClass]="{
                              'bg-purple-100 text-purple-800': user.type === 'admin',
                              'bg-blue-100 text-blue-800': user.type === 'user',
                              'bg-orange-100 text-orange-800': user.type === 'cashier',
                              'bg-gray-100 text-gray-800': user.type === 'warehouse'
                            }">
                    {{ user.type }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                  <button (click)="viewUser(user)"
                    class="text-purple-600 hover:text-purple-900 p-1 hover:bg-purple-100 rounded transition-colors">
                    <fa-icon [icon]="faEye"></fa-icon>
                  </button>
                  <button (click)="editUser(user)"
                    class="text-blue-600 hover:text-blue-900 p-1 hover:bg-blue-100 rounded transition-colors">
                    <fa-icon [icon]="faPen"></fa-icon>
                  </button>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        }
        }

        <!-- Error State -->
        @if (state().error) {
        <div class="flex flex-col items-center justify-center py-12 text-center animate__animated animate__fadeIn">
          <div class="bg-red-50 p-4 rounded-full mb-4">
            <fa-icon [icon]="faTimes" class="text-red-500 text-2xl"></fa-icon>
          </div>
          <h3 class="text-lg font-medium text-gray-900">Error al cargar usuarios</h3>
          <p class="text-gray-500 mt-1 max-w-sm">{{ state().error }}</p>
          <button (click)="loadUsers()" class="mt-4 text-purple-600 hover:text-purple-700 font-medium hover:underline">
            Intentar nuevamente
          </button>
        </div>
        }

        <!-- Empty State -->
        @if (!state().loading && !state().error && filteredUsers().length === 0) {
        <div
          class="flex flex-col items-center justify-center py-20 px-4 bg-gradient-to-b from-white via-gray-50 to-gray-100 rounded-lg border border-gray-200 animate__animated animate__fadeIn">
          <div class="bg-white p-4 rounded-full shadow-sm mb-4">
            <fa-icon [icon]="faUserSlash" class="text-purple-400 text-4xl"></fa-icon>
          </div>
          <h2 class="text-xl font-semibold text-gray-800 mb-2">No se encontraron usuarios</h2>
          <p class="text-gray-500 text-sm text-center max-w-md">
            {{ state().searchTerm ? 'No hay resultados para tu búsqueda. Intenta con otros términos.' : 'Aún no hay
            usuarios registrados en el sistema.' }}
          </p>
          @if (state().searchTerm) {
          <button (click)="handleClearFilters()"
            class="mt-6 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium shadow-sm">
            Limpiar filtros
          </button>
          }
        </div>
        }

      </main>
    </div>
  </div>
</div>

<!-- Modales -->
@if (state().showViewModal) {
<app-user-view-modal [user]="state().selectedUser" (closeModal)="closeModal()"></app-user-view-modal>
} @if (state().showEditModal) {
<app-user-edit-modal [user]="state().selectedUser" (closeModal)="closeModal(true)"></app-user-edit-modal>
} @if (state().showAddModal) {
<app-user-add-modal (closeModalEvent)="closeModal(true)"></app-user-add-modal>
}