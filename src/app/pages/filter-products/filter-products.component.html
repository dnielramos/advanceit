<div class="flex">
  <aside class="w-80 h-screen sticky top-0 hidden md:flex flex-col bg-white shadow-xl font-sans">

    <div class="flex flex-col flex-grow overflow-hidden mt-5">

      <div class="p-4">
        <input type="text"
               [ngModel]="searchTerm()"
               (ngModelChange)="onSearchChange($event)"
               placeholder="Buscar productos..."
               class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" />
      </div>

      <div class="flex p-2 border-b">
        <button (click)="setActiveView('categories')"
          [ngClass]="{ 'bg-purple-600 text-white shadow-md': activeView() === 'categories', 'bg-gray-100 text-gray-600 hover:bg-gray-200': activeView() !== 'categories' }"
          class="flex-1 p-2 rounded-md font-semibold text-sm transition-all duration-200 ease-in-out flex items-center justify-center gap-2">
          <fa-icon [icon]="faLayerGroup"></fa-icon> Categorías
        </button>
        <button (click)="setActiveView('brands')"
          [ngClass]="{ 'bg-purple-600 text-white shadow-md': activeView() === 'brands', 'bg-gray-100 text-gray-600 hover:bg-gray-200': activeView() !== 'brands' }"
          class="flex-1 p-2 rounded-md font-semibold text-sm transition-all duration-200 ease-in-out flex items-center justify-center gap-2">
          <fa-icon [icon]="faStar"></fa-icon> Marcas
        </button>
      </div>

      <div class="relative flex-grow overflow-hidden">
        @if (activeView() === 'categories') {
        <div class="absolute w-full h-full transition-transform duration-300 ease-in-out"
          [ngClass]="{'translate-x-0': !currentCategory(), '-translate-x-full': currentCategory()}">
          <div class="p-4 h-full overflow-y-auto">
            <h2 class="text-xl font-bold text-purple-700 mb-4">Categorías</h2>
            <ul class="space-y-3">
              @for (category of categories(); track category.category) {
              <li (click)="selectCategory(category)"
                class="flex items-center justify-between p-3 bg-gray-50 hover:bg-purple-100 rounded-lg cursor-pointer transition-colors">
                <span class="flex items-center font-medium text-gray-800">
                  <fa-icon [icon]="faCopyright" class="mr-3 text-purple-600"></fa-icon> {{ category.category }}
                </span>
                <fa-icon [icon]="faChevronRight" class="text-gray-400"></fa-icon>
              </li>
              }
            </ul>
          </div>
        </div>
        <div class="absolute w-full h-full transition-transform duration-300 ease-in-out"
          [ngClass]="{'translate-x-0': currentCategory(), 'translate-x-full': !currentCategory()}">
          @if (currentCategory(); as selectedCat) {
          <div class="p-4 h-full overflow-y-auto">
            <button (click)="goBack()"
              class="mb-4 flex items-center text-purple-600 hover:text-purple-800 font-semibold">
              <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon> Volver
            </button>
            <h2 (click)="onSelectCategory(selectedCat.category)"
              class="text-xl font-bold text-purple-700 mb-4 cursor-pointer hover:underline">
              {{ selectedCat.category }}
            </h2>
            <ul class="space-y-2">
              @for (sub of selectedCat.subCategories; track sub) {
              <li (click)="onSelectSubcategory(sub)"
                class="p-3 bg-gray-50 hover:bg-purple-100 rounded-lg cursor-pointer transition-colors text-gray-700">
                {{ sub }}
              </li>
              } @empty {
              <li class="p-2 text-gray-500">No hay subcategorías disponibles.</li>
              }
            </ul>
          </div>
          }
        </div>
        }

        @if (activeView() === 'brands') {
        <div class="absolute w-full h-full p-4 overflow-y-auto">
          <h2 class="text-xl font-bold text-purple-700 mb-4">Marcas</h2>
          <ul class="space-y-3">
            @for (brand of brands(); track brand.name) {
            <li class="flex items-center justify-between p-3 bg-gray-50 hover:bg-purple-100 rounded-lg transition-colors">
              <label class="flex items-center font-medium text-gray-800 gap-3 w-full cursor-pointer">
                <input type="checkbox"
                       [checked]="selectedBrands().has(brand.name)"
                       (change)="toggleBrand(brand.name)"
                       class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer">

                <img class="h-8 object-contain w-10"
                     src="https://advanceit.co/assets/logos/{{ brand.name | lowercase }}.png"
                     alt="logo {{ brand.name | titlecase }}">
                <span>{{ brand.name | titlecase }}</span>
              </label>
              <span class="px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-700">
                {{ brand.quantity }}
              </span>
            </li>
            }
          </ul>
        </div>
        }
      </div>
    </div>
  </aside>

  <lib-toastify-toast-container></lib-toastify-toast-container>

  <div *ngIf="showBrandsMenu()" (click)="showBrandsMenu.set(false)"
    class="bg-black/50 fixed top-0 z-50 w-full h-full flex overflow-hidden">
    <app-brand-menu (click)="$event.stopPropagation()"></app-brand-menu>
  </div>

  <div *ngIf="cartItemCount() > 0 && isLoggedIn()"
    class="fixed flex justify-center bottom-2 rounded-tl-xl rounded-bl-xl hover:cursor-pointer right-0 md:left-auto bg-purple-500 text-white animate__animated animate__fadeInRight shadow-lg w-18 h-15 z-10">
    <a (click)="goToCart()" class="relative flex items-center justify-center w-full h-full">
      <span
        class="p-2 absolute top-2 right-2 bg-purple-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
        {{ cartItemCount() }}
      </span>
      <fa-icon [icon]="faShoppingCart" class="text-xl md:text-2xl "></fa-icon>
    </a>
  </div>

  <div *ngIf="comprarProductos()" class="bg-black/50 fixed top-0 z-50 w-full h-full flex overflow-hidden">
    <app-info-login *ngIf="comprarProductos()" (close)="closeComprarProductos()" (loginAction)="handleLogin()"
      (createAction)="handleCreate()">
    </app-info-login>
  </div>

  <div *ngIf="createUser()" class="bg-black/60 backdrop-blur-sm fixed top-0 z-50 w-full h-full overflow-hidden"
    (click)="onOutregister()">
    <app-create-user></app-create-user>
  </div>

  <main class="w-full p-6 bg-gray-50">
    <div class="flex justify-between items-center mb-6">
      <h1
        class="text-sm md:text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-700 to-orange-700">
        {{ viewTitle() }}</h1>
      <button (click)="onMenuBrands()"
        class="md:hidden flex items-center gap-2 p-2 rounded-md bg-purple-600 text-white">
        <fa-icon [icon]="faFilters"></fa-icon>
        <p class="text-xs md:text-sm">Filtros</p>
      </button>
    </div>

    @if (products().length > 0) {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 items-center justify-center xl:grid-cols-3 max-w-5xl gap-6">
      @for (producto of products(); track producto.SKU) {
      <app-product-advance (agregarAlCarrito)="onComprarProductos($event)" [producto]="producto"></app-product-advance>
      }
    </div>
    }

    @if (isLoading()) {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      @for (item of [1,2,3,4]; track item) {
      <app-skeleton-filter-product></app-skeleton-filter-product>
      }
    </div>
    }

    @if (!isLoading() && products().length === 0) {
    <div class="text-center py-20">
      <p class="text-xl text-gray-500">No se encontraron productos con estos filtros.</p>
    </div>
    }

    @if (hasNextPage() && !isLoading()) {
    <div class="text-center mt-8">
      <button (click)="loadMoreProducts()"
        class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 transition-colors">
        Cargar más productos
      </button>
    </div>
    }
  </main>
</div>
